<html>
<head>
	<script src="/lib/prototype-1.6.1.js" type="text/javascript"></script>
	<script src="/lib/canvas.js" type="text/javascript"></script>
	<script src="/lib/shortcut.js" type="text/javascript"></script>
	<script src="/fred.js" type="text/javascript"></script>
	<link rel="stylesheet" href="/fred.css" type="text/css" media="screen" title="no title" charset="utf-8">
	<link rel="stylesheet" href="/spectro.css" type="text/css" media="screen" title="no title" charset="utf-8">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="viewport" content="width=device-width; height=device-height; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;"/>
</head>
<body onload="Fred.init({speed:5});setup(); //learn how to customize the Fred environment at http://github.com/jywarren/fred">

	<div id="fred"></div>

	<div style="width:20%;line-height:1.3em;background:rgba(255,255,255,0.4);position:absolute;top:8px;right:8px;padding:8px;font-family:helvetica,arial,sans-serif;font-size:22px;">
		Line the spectrum up with the edge to see its intensity graphed.
	</div>

	<div id="buttons">
		<a href="/" class='button'>&laquo; Back</a>
		<a href="javascript:void(0)" class='button' onClick='save_data()'>Save spectrum</a>
		<a href="javascript:void(0)" class='button' onClick='Fred.active_layer.objects.last().scale *= 0.9'>[-]</a>
		<a href="javascript:void(0)" class='button' onClick='Fred.active_layer.objects.last().scale *= 1.1'>[+]</a>
	</div>

	<script>

	data = ''
	
	function setup() {
		Fred.observe('fred:postdraw',draw)
		Fred.select_tool('select')
		Fred.text_style.fontColor = 'white'

		Fred.tools.import.image('<%= @spectrum.photo.url %>')

		Fred.keys.add('up',function() {Fred.active_layer.objects.last().y -= 5})
		Fred.keys.add('down',function() {Fred.active_layer.objects.last().y += 5})
		Fred.keys.add('left',function() {Fred.active_layer.objects.last().x -= 5})
		Fred.keys.add('right',function() {Fred.active_layer.objects.last().x += 5})
		Fred.keys.add('3',function() {Fred.active_layer.objects.last().scale *= 1.1})
		Fred.keys.add('4',function() {Fred.active_layer.objects.last().scale *= 0.9})
		Fred.keys.add('1',function() {Fred.active_layer.objects.last().r -= 0.1})
		Fred.keys.add('2',function() {Fred.active_layer.objects.last().r += 0.1})
	}

	function load_image() {
		// Read line of pixels:
		try {
			slice = Fred.active_layer.canvas.getImageData(0,parseInt(Fred.height/2)+1,Fred.width,1)
		} catch(e) {
			netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead")
			slice = Fred.active_layer.canvas.getImageData(0,parseInt(Fred.height/2)+1,Fred.width,1)
		}
	}

	function draw() {
		save()
			fillStyle('white')
			opacity(0.3)
			rect(0,0,Fred.width,parseInt(Fred.height/2))
			rect(Fred.pointer_x,0,1,Fred.height)
			rect(0,parseInt(Fred.height/2),Fred.width,1)
		restore()
		// Fenerate spectrum:

		// The CanvasPixelArray object can be accessed to look at the raw pixel data; 
		// each pixel is represented by four one-byte values (red, green, blue, and alpha,
		// in that order; that is, "RGBA" format). Each color component is represented by 
		// an integer between 0 and 255. Each component is assigned a consecutive index 
		// within the array, with the top left pixel's red component being at index 0 within 
		// the array. Pixels then proceed from left to right, then downward, throughout the array.

		//The CanvasPixelArray contains height x width x 4 bytes of data, with index values 
		// ranging from 0 to (height x width x 4)-1.

		// to read the blue component's value from the pixel at 
		// column 200, row 50 in the image, you would do the following:
		// blue = imageData.data[((50*(imageData.width*4)) + (200*4)) + 2];
		var row = 0
		var column = Fred.pointer_x
		var columns = []
		var tmpdata = ''
		load_image()
		save()
		beginPath()
		moveTo(0,parseInt(Fred.height/2)+1)
		for (i=0;i<Fred.width;i++) {
			var red = slice.data[((row*(slice.width*4)) + (i*4)) + 0];
			var green = slice.data[((row*(slice.width*4)) + (i*4)) + 1];
			var blue = slice.data[((row*(slice.width*4)) + (i*4)) + 2];
			var amplitude = (red+blue+green)/3
			columns.push([red,green,blue,amplitude])
			data += red+','+green+','+blue+','+amplitude+'/'
			lineTo(i,parseInt(Fred.height/2)+1-amplitude)
		}
		strokeStyle('white')
		lineWidth(1)
		stroke()
		data = tmpdata
		//console.log(amplitude+' '+red+','+green+','+blue+': '+(parseInt(Fred.pointer_x)))	
		restore()
	}

	function save_data() {
		new Ajax.Request('/spectrums/update/<%= @spectrum.id %>',{
			method: 'get',
			parameters: {
				data: data
			}
		})
	}

	</script>

</body>
</html>
