<style>

.content {
	background:#444;
	color:#eee;
}

</style>
<script>

flotoptions.grid = {
		clickable: true,
		hoverable:true,
		borderWidth: 0,
		color: "#ccc",
	        backgroundColor: "#111"
}
flotoptions.colors = [ "#ccc", "#E02130", "#FAB243", "#429867", "#2B5166" ]//, "#482344" ]
</script>

<div data-role="panel" data-id="menu">
<div data-role="page" id="page0" data-theme="a">
  <div data-theme="a" data-role="header">
    <h3 style="text-align:left;margin-left:15px;">Tools</h3>
  </div>
  <div data-role="content" class="content" style="padding: 15px">
    <div id="notify"></div>
    <!--<a data-role="button" data-theme="a" href="javascript:void()" onClick="">Calibrate</a>-->
    <div data-role="fieldcontain">
      <fieldset data-role="controlgroup">
        <label for="geotag-toggle">Geotag</label>
        <input data-theme="a" type="checkbox" name="geotag-toggle" id="geotag-toggle" type="checkbox" />
        <label for="rgb-toggle">RGB</label>
        <input data-theme="a" type="checkbox" name="rgb-toggle" id="rgb-toggle" onChange="$W.toggle_mode()" />
      </fieldset>
    </div>

    <p>
	<b>Upcoming features:</b>
    </p>
	<ul>
	<li>Range limiting</li>
	<li>Auto-calibrate</li>
	<li>Baseline storage</li>
	<li>Choose set to match against</li>
	</ul>
    <p>Your input is invaluable! See <a href="https://github.com/jywarren/spectral-workbench/issues">Github issues</a> to help design/refine/debug new features.<p>
    <a data-role="button" data-theme="a" href="#configure" data-panel="main">Configure</a>
    <p>Don't see anything? <a href="http://publiclaboratory.org/wiki/spectral-workbench-web-video">Check if your browser is supported</a></p>

  </div>
</div>
</div>

<div data-role="panel" data-id="main">
<div data-role="page" id="main" data-theme="a">
  <div data-theme="a" data-role="header">
    <h3 class="header" style="text-align:left;margin-left:15px;">
      <img src="/images/spectralworkbench.png" /> 
      <a style="margin-left:3px;color:white;text-decoration:none;" id="home" data-theme="b" href="/">SpectralWorkbench</a>
    </h3>
  </div>

  <div data-role="content" class="content" style="padding: 15px">

	<% if params[:action] == "match" %>
	<p><b>Click "Match" to find the closest spectrum in the set "<%= @set.title %>"</b></p>
	<% end %>

	<div id="graph" style="width:100%;height:200px;"></div>
	<br />
	<canvas style="width:100%;height:100px;" id="canvas"></canvas> 

	<span id="match"></span>

	<% if params[:action] == "match" %>
    <a data-role="button" data-theme="a" href="javascript:void()" onClick="$W.match();">Match</a>
    <a data-role="button" data-transition="fade" data-theme="a" href="#page2" onClick="$W.saveSpectrum();">Save</a>
	<% else %>
    <a data-role="button" data-transition="fade" data-theme="a" href="#page2" onClick="$W.saveSpectrum();">Save</a>
	<% end %>

    <% unless logged_in? %><p><a href="/login">Log in</a> to use a recent calibration</p><% end %>
    <p>This interface works on <a href="https://www.google.com/intl/en/chrome/browser/">Chrome 21+</a> and any browser which supports the HTML5 MediaStream (WebRTC video) API. <a href="https://play.google.com/store/apps/details?id=com.opera.browser">Opera Mobile</a> for Android also works!</p>

    <p><a href="https://github.com/jywarren/spectral-workbench">SpectralWorkbench is free software</a> by <a href="http://publiclaboratory.org">Public Lab</a></p>

  </div>
</div>

<div data-role="page" id="page2" data-theme="a">
  <div data-theme="a" data-role="header">
    <h3 style="text-align:left;margin-left:15px;">Save spectrum</h3>
  </div>

  <div data-role="content" class="content" style="padding: 15px">

	<% if !logged_in? %>
		<p>You must be <a target="_blank" href="/login">logged in</a> to save spectra.</p>
	<% else %>
		<p>(logged in as <%=h current_user.login %>)</p>
	<% end %>

	<form action="/spectrums" method="post" id="saveForm" target="_blank" onSubmit="$W.cancelSave();window.location='#main'">
		<label for="spectrum_title">Title:</label><br />
		<input name="spectrum[title]" id="spectrum_notes" type="text" /><br />
		<label for="tags">Tags:</label><br />
		<input name="tags" id="spectrum_tags" value="" type="text" /><br />
		<label for="spectrum_notes">Notes:</label>
		<textarea name="spectrum[notes]" id="spectrum_notes"></textarea><br />
		<input name="dataurl" type="hidden" id="dataurl" />
		<input name="geotag" type="hidden" id="geotag" />
		<input name="lat" type="hidden" id="lat" />
		<input name="lon" type="hidden" id="lon" />
		<% if logged_in? %>
		<select name="spectrum[calibration_id]" id="calibration_id">
			<% current_user.tag('calibration').each do |spectrum| %>
			<option value="<%= spectrum.id %>"><%= spectrum.title %> (<%= time_ago_in_words(spectrum.created_at) %>)</option>
			<% end %>
		</select>
		<% end %>
	</form>
	<a data-role="button" data-transition="fade" data-theme="b" href="javascript:void(0);" onClick="$('#saveForm').submit()">Save</a>
	<a data-role="button" data-transition="fade" data-theme="d" href="#main" onClick="$W.cancelSave()">&laquo; Back</a>

  </div>
</div>


<div data-role="page" id="configure" data-theme="a">
  <div data-theme="a" data-role="header">
    <h3 style="text-align:left;margin-left:15px;">Configure</h3>
  </div>

  <div data-role="content" class="content" style="padding: 15px">
		<p style="display:none;" id="local_calibration">This device has a locally stored calibration. <a href="" id="local_calibration_link">Click here</a> to use it.</p>
		<script>
			if (localStorage.getItem("sw:calibration_id")) {
				$("#local_calibration_link")[0].href = "/capture?calibration_id="+localStorage.getItem("sw:calibration_id")
				$("#local_calibration").show()
			}
		</script>
		<% if logged_in? %>
		<p>Store a calibration in your browser:</p>
		<select id="local_calibration_select">
			<% current_user.tag('calibration').each do |spectrum| %>
			<option value="<%= spectrum.id %>"><%= spectrum.title %> (<%= time_ago_in_words(spectrum.created_at) %>)</option>
			<% end %>
		</select><br />
		<div style="padding:10px 0;">
			<a href="javascript:void()" onClick="localStorage.setItem('sw:calibration_id',$('#local_calibration_select').val())" class="smallbutton">Store calibration</a><br style="clear:both;"/>
		</div>
		<% end %>
		
		<p><i>This panel is under construction</i></p>

		<label for="range">Range:</label>
		<input type="text" id="range" style="border:0; font-weight:bold;" />
		<br />
		<div style="float:right;height:480px;" id="sample_slider"></div>
		<div id="webcam"></div> 
		<a data-role="button" data-theme="a" href="#main" data-panel="main">&laquo; Back</a>
	</div>
  </div>
</div>

<script> (function () { 
	$W.initialize({
		calibrated:<%= !@calibration.nil? %>,
		mobile:false
	}) 
	setInterval($W.getRow,100)
	<% if @calibration %>
		$W.calibrated = true
		$W.calibration_id = <%= @calibration.id %>
		$W.start_wavelength = <%= @start_wavelength %>
		$W.end_wavelength = <%= @end_wavelength %>
    		flotoptions.xaxis.show = true
	<% else %>
		$W.calibrated = false
	<% end %>
	<% if params[:action] == "match" %>
		$W.set = <%= @set.id %>
	<% end %>
})() </script>
